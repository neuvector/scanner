name: Update sigstore-interface dependency

scms:
  scanner:
    kind: github
    spec:
      user: "{{ .github.author }}"
      email: "{{ .github.email }}"
      directory: "/tmp/scanner"
      owner: "{{ requiredEnv .github.owner }}"
      repository: "scanner"
      token: "{{ requiredEnv .github.token }}"
      username: "{{ requiredEnv .github.user }}"
      branch: "{{ .github.branch }}"
      commitmessage:
        type: "chore"
        title: "Update sigstore-interface to latest commit"
        hidecredit: true
        footers: "Signed-off-by: neuvector bot <neuvector-bot@users.noreply.github.com>"

sources:
  sigstoreLatestCommit:
    name: Get latest sigstore-interface commit
    kind: shell
    spec:
      command: |
        set -eu
        git ls-remote https://github.com/neuvector/sigstore-interface.git main | awk 'NR==1 {print $1}'

targets:
  updateSigstoreVersion:
    name: Update sigstore-interface version in Dockerfile
    scmid: scanner
    sourceid: sigstoreLatestCommit
    kind: file
    spec:
      file: package/Dockerfile
      matchpattern: 'ARG SIGSTORE_VERSION=.*'
      replacepattern: 'ARG SIGSTORE_VERSION={{ source "sigstoreLatestCommit" }}'

actions:
  default:
    kind: github/pullrequest
    scmid: scanner
    spec:
      title: 'chore: update sigstore-interface to latest commit ({{ now | date "2006-01-02" }})'
      description: |
        This PR updates sigstore-interface to the latest commit from the main branch.

        Changes:
        - Updated sigstore-interface to latest commit: {{ source "sigstoreLatestCommit" }}
      labels:
        - dependencies
      automerge: false